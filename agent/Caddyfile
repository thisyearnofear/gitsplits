# Caddy configuration for EigenCompute TLS
{$DOMAIN:localhost} {
    # Use certs provisioned by compute-source-env
    tls /run/tls/fullchain.pem /run/tls/privkey.pem

    # Agent server runs on 8443 in EigenCompute runtime
    reverse_proxy 127.0.0.1:8443 {
        health_uri /health
        health_interval 30s
        health_timeout 5s
        health_status 200
    }

    header {
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

:80 {
    @for_domain expression {host} != "localhost"
    redir @for_domain https://{host}{uri} permanent

    handle /health {
        respond "OK" 200
    }
}
