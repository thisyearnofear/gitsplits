version: "3"
services:
  # Frontend service
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    image: gitsplits-frontend:latest
    container_name: gitsplits-frontend
    environment:
      # NEAR Contract Configuration
      - NEXT_PUBLIC_PROJECT_ID=${NEXT_PUBLIC_PROJECT_ID}
      - NEXT_PUBLIC_contractId=${NEXT_PUBLIC_contractId}
      - NEXT_PUBLIC_accountId=${NEXT_PUBLIC_accountId}
      - NEXT_PUBLIC_secretKey=${NEXT_PUBLIC_secretKey}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}

      # Application Configuration
      - NODE_ENV=production
    ports:
      - "3000:3000"
    restart: always
    healthcheck:
      test:
        ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./logs:/app/logs
    networks:
      - gitsplits-network

  # Sovereign Monolith Agent (Phala/dstack)
  agent:
    build:
      context: .
      dockerfile: packages/controller-phala/Dockerfile
    image: gitsplits-agent:latest
    container_name: gitsplits-agent
    environment:
      # Application Configuration
      - NODE_ENV=production
      - AGENT_MODE=${AGENT_MODE}
      - PORT=43127

      # NEAR Configuration
      - NEAR_NETWORK_ID=mainnet
      - NEAR_NODE_URL=https://rpc.mainnet.near.org
      - NEAR_CONTRACT_ID=${NEAR_CONTRACT_ID}
      - NEAR_ACCOUNT_ID=${NEAR_ACCOUNT_ID}
      - NEAR_PRIVATE_KEY=${NEAR_PRIVATE_KEY}

      # GitHub Configuration
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - GITHUB_APP_ID=${GITHUB_APP_ID}
      - GITHUB_PRIVATE_KEY=${GITHUB_PRIVATE_KEY}

      # EigenAI Configuration
      - EIGENAI_WALLET_ADDRESS=${EIGENAI_WALLET_ADDRESS}
      - EIGENAI_WALLET_PRIVATE_KEY=${EIGENAI_WALLET_PRIVATE_KEY}

      # Payment Rails
      - PING_PAY_API_KEY=${PING_PAY_API_KEY}
      - PING_PAY_AUTH_MODE=${PING_PAY_AUTH_MODE}
      - PING_PAY_API_BASE=${PING_PAY_API_BASE}
      - PING_PAY_PROBE_PATH=${PING_PAY_PROBE_PATH}
      - PING_PAY_PROBE_METHOD=${PING_PAY_PROBE_METHOD}
      - PING_PAY_PROBE_BODY=${PING_PAY_PROBE_BODY}
      - PING_PAY_WEBHOOK_SECRET=${PING_PAY_WEBHOOK_SECRET}
      - HOT_PAY_JWT=${HOT_PAY_JWT}
      - AGENT_API_KEY=${AGENT_API_KEY}
      - AGENT_SERVER_API_KEY=${AGENT_SERVER_API_KEY}

      # Canary Controls
      - TEST_ANALYZE_REPO=${TEST_ANALYZE_REPO}
      - TEST_CREATE_REPO=${TEST_CREATE_REPO}
      - TEST_PAY_REPO=${TEST_PAY_REPO}
      - TEST_PAY_TOKEN=${TEST_PAY_TOKEN}
      - TEST_PAY_AMOUNT=${TEST_PAY_AMOUNT}
      - TEST_PAY_MAX_AMOUNT=${TEST_PAY_MAX_AMOUNT}
      - TEST_CANARY_REPOS=${TEST_CANARY_REPOS}

      # Social
      - NEYNAR_API_KEY=${NEYNAR_API_KEY}
      - NEYNAR_SIGNER_UUID=${NEYNAR_SIGNER_UUID}
      - FARCASTER_BOT_FID=${FARCASTER_BOT_FID}
    ports:
      - "43127:43127"
    restart: always
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:43127/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - ./logs:/app/logs
    networks:
      - gitsplits-network

networks:
  gitsplits-network:
    driver: bridge
